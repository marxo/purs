<!DOCTYPE html>
<html lang="sr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–ú–∏–Ω–∏–º–∞–ª–Ω–∏ –°–∫–µ–Ω–µ—Ä - ISO –ò–∑–≤–æ–∑</title>
    <script src="https://unpkg.com/@zxing/library@latest"></script>
    <style>
        body { font-family: sans-serif; text-align: center; margin: 0; padding: 20px; background: #f4f4f4; }
        #video { width: 100%; max-width: 400px; background: #000; border-radius: 8px; }
        .controls { margin: 20px 0; }
        button { padding: 15px 25px; font-size: 16px; border: none; border-radius: 5px; cursor: pointer; font-weight: bold; }
        #startBtn { background: #007bff; color: white; }
        #downloadBtn { background: #28a745; color: white; margin-left: 10px; }
        table { width: 100%; border-collapse: collapse; margin-top: 20px; background: white; font-size: 11px; }
        th, td { border: 1px solid #ddd; padding: 8px; text-align: left; }
        th { background: #eee; }
        .status { color: #555; margin: 10px 0; font-weight: bold; }
        .link-btn { color: #007bff; text-decoration: none; font-weight: bold; }
    </style>
</head>
<body>

    <h3>üìë –°–∫–µ–Ω–µ—Ä —Ä–∞—á—É–Ω–∞ (ISO –ò–∑–≤–æ–∑)</h3>
    <div id="status" class="status">–ö–ª–∏–∫–Ω–∏—Ç–µ "–ü–û–ö–†–ï–ù–ò –ö–ê–ú–ï–†–£"</div>
    
    <video id="video"></video>

    <div class="controls">
        <button id="startBtn">–ü–û–ö–†–ï–ù–ò –ö–ê–ú–ï–†–£</button>
        <button id="downloadBtn">EXCEL (CSV)</button>
    </div>

    <table id="resultTable">
        <thead>
            <tr>
                <th>–î–∞—Ç—É–º (ISO)</th>
                <th>–ü–§–†</th>
                <th>–ü—Ä–µ–¥—É–∑–µ—õ–µ</th>
                <th>–ò–∑–Ω–æ—Å</th>
                <th>–õ–∏–Ω–∫</th>
            </tr>
        </thead>
        <tbody></tbody>
    </table>

    <script>
        const codeReader = new ZXing.BrowserQRCodeReader();
        let scannedData = [];

        // –ü–æ–º–æ—õ–Ω–∞ —Ñ—É–Ω–∫—Ü–∏—ò–∞ –∑–∞ –∫–æ–Ω–≤–µ—Ä–∑–∏—ò—É –¥–∞—Ç—É–º–∞ DD.MM.YYYY -> YYYY-MM-DD
        function formatToISO(dateStr) {
            if (!dateStr || dateStr === "–ù–µ–ø–æ–∑–Ω–∞—Ç") return "";
            const parts = dateStr.split('.');
            if (parts.length >= 3) {
                return `${parts[2]}-${parts[1]}-${parts[0]}`;
            }
            return dateStr;
        }

        document.getElementById('startBtn').addEventListener('click', () => {
            document.getElementById('status').innerText = "üì∑ –¢—Ä–∞–∂–∏–º QR –∫–æ–¥...";
            codeReader.decodeFromVideoDevice(null, 'video', (result, err) => {
                if (result) {
                    if (navigator.vibrate) navigator.vibrate(100);
                    processURL(result.text);
                    codeReader.reset();
                    setTimeout(() => document.getElementById('startBtn').click(), 2500);
                }
            });
            document.getElementById('startBtn').style.display = 'none';
        });

        async function processURL(url) {
            const proxy = "https://corsproxy.io/?";
            try {
                const response = await fetch(proxy + encodeURIComponent(url));
                const html = await response.text();
                
                const parser = new DOMParser();
                const doc = parser.parseFromString(html, "text/html");
                const fullText = doc.body.innerText;
                const allLines = fullText.split('\n').map(l => l.trim()).filter(l => l.length > 0);

                let shopName = "–ù–µ–ø–æ–∑–Ω–∞—Ç–æ";
                let pib = "–ù–µ–ø–æ–∑–Ω–∞—Ç";

                const startIndex = allLines.findIndex(line => line.includes("–§–ò–°–ö–ê–õ–ù–ò –†–ê–ß–£–ù"));
                if (startIndex !== -1) {
                    for (let i = startIndex; i < allLines.length; i++) {
                        if (/^\d{9}$/.test(allLines[i])) {
                            pib = allLines[i];
                            if (i + 1 < allLines.length) {
                                shopName = allLines[i + 1];
                            }
                            break;
                        }
                    }
                }

                if (pib === "–ù–µ–ø–æ–∑–Ω–∞—Ç") {
                    const pibElem = doc.getElementById('pib');
                    if (pibElem) pib = pibElem.innerText.trim();
                }

                if (shopName === "–ù–µ–ø–æ–∑–Ω–∞—Ç–æ" || shopName.includes("–ó–∞—Ö—Ç–µ–≤ –∑–∞ —Ñ–∏—Å–∫–∞–ª–∏–∑–∞—Ü–∏—ò—É")) {
                    const shopElem = doc.getElementById('shopName');
                    if (shopElem) shopName = shopElem.innerText.trim();
                }

                const pfrMatch = fullText.match(/[A-Z0-9]{8}-[A-Z0-9]{8}-\d+/);
                const dateMatch = fullText.match(/(\d{2}\.\d{2}\.\d{4})/);
                const iznosMatch = fullText.match(/–£–∫—É–ø–∞–Ω –∏–∑–Ω–æ—Å[:\s]+([\d\.,]+)/i);

                const rawDate = dateMatch ? dateMatch[1] : "–ù–µ–ø–æ–∑–Ω–∞—Ç";

                const item = {
                    isoDate: formatToISO(rawDate),
                    pfr: pfrMatch ? pfrMatch[0] : "–ì—Ä–µ—à–∫–∞",
                    shop: shopName,
                    pib: pib,
                    total: iznosMatch ? iznosMatch[1] : "0,00",
                    url: url
                };

                scannedData.push(item);
                updateTable();
                document.getElementById('status').innerText = "‚úÖ –î–æ–¥–∞—Ç–æ: " + shopName;
            } catch (e) {
                document.getElementById('status').innerText = "‚ö†Ô∏è –ì—Ä–µ—à–∫–∞ —Å–∞ –∫–æ–Ω–µ–∫—Ü–∏—ò–æ–º.";
            }
        }

        function updateTable() {
            const tbody = document.querySelector('#resultTable tbody');
            tbody.innerHTML = scannedData.map(r => 
                `<tr>
                    <td>${r.isoDate}</td>
                    <td><small>${r.pfr}</small></td>
                    <td><strong>${r.shop}</strong><br><small>–ü–ò–ë: ${r.pib}</small></td>
                    <td>${r.total}</td>
                    <td><a href="${r.url}" target="_blank" class="link-btn">üîó</a></td>
                </tr>`
            ).join('');
        }

        document.getElementById('downloadBtn').addEventListener('click', () => {
            if (scannedData.length === 0) return alert("–¢–∞–±–µ–ª–∞ —ò–µ –ø—Ä–∞–∑–Ω–∞");
            
            // –ù–æ–≤–∏ —Ä–µ–¥–æ—Å–ª–µ–¥ –∫–æ–ª–æ–Ω–∞ –∑–∞ –∏–∑–≤–æ–∑: –î–∞—Ç—É–º, –ü–§–†, –ü—Ä–µ–¥—É–∑–µ—õ–µ, –ò–∑–Ω–æ—Å, –õ–∏–Ω–∫
            let csv = "\uFEFFDatum,PFR,Preduzece,Iznos,Link\n";
            scannedData.forEach(r => {
                csv += `"${r.isoDate}","${r.pfr}","${r.shop}","${r.total}","${r.url}"\n`;
            });

            const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement("a");
            link.href = URL.createObjectURL(blob);
            link.download = `racuni_export_${new Date().toISOString().split('T')[0]}.csv`;
            link.click();
        });
    </script>
</body>
</html>